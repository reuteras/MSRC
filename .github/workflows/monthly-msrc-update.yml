---
name: Monthly MSRC Data Update

on:
  schedule:
    # Run on the 15th of every month at 2:00 AM UTC (after Patch Tuesday)
    - cron: '0 2 15 * *'
  workflow_dispatch:
    inputs:
      year:
        description: 'Year (YYYY) - leave empty for current month'
        required: false
        type: string
      month:
        description: 'Month (Jan/Feb/Mar/etc) - leave empty for current month'
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate-msrc-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set time period
        id: timeperiod
        env:
          INPUT_YEAR: ${{ github.event.inputs.year }}
          INPUT_MONTH: ${{ github.event.inputs.month }}
        run: |
          if [ -n "${INPUT_YEAR}" ] && [ -n "${INPUT_MONTH}" ]; then
            TIMEPERIOD="${INPUT_YEAR}-${INPUT_MONTH}"
          else
            TIMEPERIOD=$(date '+%Y-%b')
          fi
          echo "timeperiod=${TIMEPERIOD}" >> "$GITHUB_OUTPUT"
          echo "Generating report for: ${TIMEPERIOD}"

      - name: Generate MSRC report
        env:
          APIKEY: ${{ secrets.MSRC_API_KEY }}
          TIMEPERIOD: ${{ steps.timeperiod.outputs.timeperiod }}
        run: |
          docker run --rm \
            -e APIKEY="$APIKEY" \
            -e TIMEPERIOD="$TIMEPERIOD" \
            -v "${{ github.workspace }}":/mnt \
            mcr.microsoft.com/powershell \
            pwsh -Command '
              Install-Module -Name MSRCSecurityUpdates -Force -Scope CurrentUser
              Import-Module MSRCSecurityUpdates -Verbose:$false
              Set-MSRCApiKey -ApiKey $env:APIKEY
              $timeperiod = $env:TIMEPERIOD
              $fname_cve = "/mnt/Reports/MSRC_CVEs" + $timeperiod + ".html"
              Get-MsrcCvrfDocument -ID $timeperiod |
                Get-MsrcVulnerabilityReportHtml |
                Out-File $fname_cve
            '

      - name: Check for changes
        id: check_changes
        run: |
          git add Reports
          git diff --cached --exit-code Reports/ || \
            echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          PERIOD: ${{ steps.timeperiod.outputs.timeperiod }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email \
            "github-actions[bot]@users.noreply.github.com"
          git add Reports/*.html
          git commit -m "Add data for ${PERIOD}"
          git push

      - name: No changes detected
        if: steps.check_changes.outputs.has_changes != 'true'
        run: |
          echo "No new changes detected. Report may already exist."
