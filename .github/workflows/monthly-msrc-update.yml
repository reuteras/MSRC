---
name: Monthly MSRC Data Update

on:
  schedule:
    # Run on the 15th of every month at 2:00 AM UTC (after Patch Tuesday)
    - cron: '0 2 15 * *'
  workflow_dispatch:
    inputs:
      year:
        description: 'Year (YYYY) - leave empty for current month'
        required: false
        type: string
      month:
        description: 'Month (Jan/Feb/Mar/etc) - leave empty for current month'
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate-msrc-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set time period
        id: timeperiod
        run: |
          if [ -n "${{ github.event.inputs.year }}" ] && \
             [ -n "${{ github.event.inputs.month }}" ]; then
            YEAR="${{ github.event.inputs.year }}"
            MONTH="${{ github.event.inputs.month }}"
            TIMEPERIOD="${YEAR}-${MONTH}"
          else
            TIMEPERIOD=$(date '+%Y-%b')
          fi
          echo "timeperiod=${TIMEPERIOD}" >> "$GITHUB_OUTPUT"
          echo "Generating report for: ${TIMEPERIOD}"

      - name: Generate MSRC report
        env:
          APIKEY: ${{ secrets.MSRC_API_KEY }}
          TIMEPERIOD: ${{ steps.timeperiod.outputs.timeperiod }}
        run: |
          docker run --rm \
            -e APIKEY="$APIKEY" \
            -e TIMEPERIOD="$TIMEPERIOD" \
            -v "${{ github.workspace }}":/mnt \
            mcr.microsoft.com/powershell \
            pwsh -Command '
              Install-Module -Name MSRCSecurityUpdates -Force -Scope CurrentUser
              Import-Module MSRCSecurityUpdates -Verbose:$false
              Set-MSRCApiKey -ApiKey $env:APIKEY
              $timeperiod = $env:TIMEPERIOD
              $fname_cve = "MSRC_CVEs" + $timeperiod + ".html"
              Get-MsrcCvrfDocument -ID $timeperiod | Get-MsrcVulnerabilityReportHtml | Out-File $fname_cve
              Copy-Item *.html /mnt/Reports/ -Force
            '

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet Reports/ || \
            echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email \
            "github-actions[bot]@users.noreply.github.com"
          git add Reports/*.html
          PERIOD="${{ steps.timeperiod.outputs.timeperiod }}"
          git commit -m "Add data for ${PERIOD}"
          git push

      - name: No changes detected
        if: steps.check_changes.outputs.has_changes != 'true'
        run: |
          echo "No new changes detected. Report may already exist."
